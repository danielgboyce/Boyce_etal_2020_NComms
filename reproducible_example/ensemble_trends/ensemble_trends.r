#REPDODUCIBLE CODE WILL IMPORT A SMALLER DATASET, CONTAINING FORECASTS FROM N=50 GRID CELLS, AND ESTIMATE LINEAR MIXED MODEL ENSEMBLE TIME TRENDS

#INSTALL AND LOAD REQUIRED PACKAGES
install.packages(c('dplyr','nlme','tidyr','plyr','data.table'))
library(dplyr)
library(nlme)
library(tidyr)
library(plyr)
library(data.table)

load('fdat_reprod.RData')


##########################################################
#FIT MODELS TO EACH 1 DEGREE CELL AND RESPONSE AND SAVE
MFUN<-function(d){

#CONVERT TO LONG FORMAT
d<-tidyr::gather(data=d,year,y,'X2006':'X2100')
d$year<-as.numeric(gsub('X','',d$year))
d<-subset(d,is.na(y)==FALSE)

#GET VARIABLES FOR OUTPUT
rcp<-unique(d$rcp)
cell<-unique(d$cell)
lon<-unique(d$lon)
lat<-unique(d$lat)
var<-unique(d$var)
units<-unique(d$units)
n<-length(unique(d$re))
nrcp<-length(unique(d$rcp))
nmod<-length(unique(d$model))
nocmod<-length(unique(d$oceanm))

f<-function(a){    return(data.frame(y=mean(a$y))) }
d<-ddply(d,.(re,year),.fun=f)

#MIXED MODEL
tcor<-Initialize(corCAR1(form= ~year | re,fixed=FALSE),data=d)
mod<-try(lme(y~year,correlation=tcor,data=d,random=list(re=~1 + year),control=list(maxIter=500,mxMaxIter=500,niterEM=50),method='ML'),TRUE)

#################################################
#IF MODEL DOES NOT CONVERGE, RETURN ERROR MESSAGE
if('TRUE' %in% grepl('Error',mod)){
tab1=data.frame(rcp=rcp,
                 cell=cell,
                 lon=lon,
                 lat=lat,
                 var=var,
                 units=units,
                 nmod=nmod,
                 nocmod=nocmod,
                 b=-999,
                 bse=-999,
                 bpv=-999,
                 nrcp=nrcp,
                 n=n)
} else {


#IF MODEL DOES FIT OUTPUT RANDOM EFFECTS YEARLY TREND
s<-summary(mod)
#OUTPUTS RANDOM EFFECTS YEARLY TREND
tab1=data.frame(rcp=rcp,
                 cell=cell,
                 lon=lon,
                 lat=lat,
                 var=var,
                 units=units,
                 nmod=nmod,
                 nocmod=nocmod,
                 b=s$tTable[2,1],
                 bse=s$tTable[2,2],
                 bpv=s$tTable[2,5],
                 nrcp=nrcp,
                 n=n)
}

return(tab1)
}

dout<-data.frame(rbindlist(dlply(fdat,.(cell,rcp),.fun=MFUN,.progress='text')))


#EXPECTED OUTPUT (-999=NOT ESTIMABLE):
    rcp         cell    lon   lat var units nmod nocmod             b
1   2.6  -173.5_-0.5 -173.5  -0.5 tcb  pctb    6      2   -0.18218307
2   8.5  -173.5_-0.5 -173.5  -0.5 tcb  pctb    6      2   -0.51086848
3   2.6  -173.5_-1.5 -173.5  -1.5 tcb  pctb    6      2   -0.19775457
4   8.5  -173.5_-1.5 -173.5  -1.5 tcb  pctb    6      2   -0.61581687
5   2.6 -173.5_-10.5 -173.5 -10.5 tcb  pctb    6      2   -0.04779169
6   8.5 -173.5_-10.5 -173.5 -10.5 tcb  pctb    6      2   -0.28989962
7   2.6 -173.5_-11.5 -173.5 -11.5 tcb  pctb    6      2 -999.00000000
8   8.5 -173.5_-11.5 -173.5 -11.5 tcb  pctb    6      2   -0.25317985
9   2.6 -173.5_-12.5 -173.5 -12.5 tcb  pctb    6      2 -999.00000000
10  8.5 -173.5_-12.5 -173.5 -12.5 tcb  pctb    6      2   -0.29337718
11  2.6 -173.5_-13.5 -173.5 -13.5 tcb  pctb    6      2   -0.05215709
12  8.5 -173.5_-13.5 -173.5 -13.5 tcb  pctb    6      2   -0.26556104
13  2.6 -173.5_-14.5 -173.5 -14.5 tcb  pctb    6      2   -0.05106130
14  8.5 -173.5_-14.5 -173.5 -14.5 tcb  pctb    6      2   -0.23689253
15  2.6 -173.5_-15.5 -173.5 -15.5 tcb  pctb    6      2   -0.04132244
16  8.5 -173.5_-15.5 -173.5 -15.5 tcb  pctb    6      2   -0.27718494
17  2.6 -173.5_-16.5 -173.5 -16.5 tcb  pctb    6      2   -0.05512997
18  8.5 -173.5_-16.5 -173.5 -16.5 tcb  pctb    6      2   -0.22627913
19  2.6 -173.5_-17.5 -173.5 -17.5 tcb  pctb    6      2   -0.06243097
20  8.5 -173.5_-17.5 -173.5 -17.5 tcb  pctb    6      2   -0.15611234
21  2.6 -173.5_-18.5 -173.5 -18.5 tcb  pctb    6      2   -0.05997677
22  8.5 -173.5_-18.5 -173.5 -18.5 tcb  pctb    6      2   -0.13877026
23  2.6 -173.5_-19.5 -173.5 -19.5 tcb  pctb    6      2   -0.04139693
24  8.5 -173.5_-19.5 -173.5 -19.5 tcb  pctb    6      2   -0.12578835
25  2.6  -173.5_-2.5 -173.5  -2.5 tcb  pctb    6      2   -0.20357646
26  8.5  -173.5_-2.5 -173.5  -2.5 tcb  pctb    6      2   -0.64793845
27  2.6 -173.5_-20.5 -173.5 -20.5 tcb  pctb    6      2   -0.04643254
28  8.5 -173.5_-20.5 -173.5 -20.5 tcb  pctb    6      2   -0.17207552
29  2.6 -173.5_-21.5 -173.5 -21.5 tcb  pctb    6      2   -0.03716363
30  8.5 -173.5_-21.5 -173.5 -21.5 tcb  pctb    6      2   -0.19794084
31  2.6 -173.5_-22.5 -173.5 -22.5 tcb  pctb    6      2   -0.02065275
32  8.5 -173.5_-22.5 -173.5 -22.5 tcb  pctb    6      2   -0.21632618
33  2.6 -173.5_-23.5 -173.5 -23.5 tcb  pctb    6      2    0.01687698
34  8.5 -173.5_-23.5 -173.5 -23.5 tcb  pctb    6      2   -0.21829844
35  2.6 -173.5_-24.5 -173.5 -24.5 tcb  pctb    6      2    0.10251142
36  8.5 -173.5_-24.5 -173.5 -24.5 tcb  pctb    6      2   -0.23292477
37  2.6 -173.5_-25.5 -173.5 -25.5 tcb  pctb    6      2    0.19246982
38  8.5 -173.5_-25.5 -173.5 -25.5 tcb  pctb    6      2   -0.30202664
39  2.6 -173.5_-26.5 -173.5 -26.5 tcb  pctb    6      2    0.23611867
40  8.5 -173.5_-26.5 -173.5 -26.5 tcb  pctb    6      2   -0.43378485
41  2.6 -173.5_-27.5 -173.5 -27.5 tcb  pctb    6      2    0.22590848
42  8.5 -173.5_-27.5 -173.5 -27.5 tcb  pctb    6      2   -0.53959248
43  2.6 -173.5_-28.5 -173.5 -28.5 tcb  pctb    6      2    0.17261129
44  8.5 -173.5_-28.5 -173.5 -28.5 tcb  pctb    6      2   -0.55087937
45  2.6  -173.5_-3.5 -173.5  -3.5 tcb  pctb    6      2   -0.21107656
46  8.5  -173.5_-3.5 -173.5  -3.5 tcb  pctb    6      2   -0.54082646
47  2.6  -173.5_-4.5 -173.5  -4.5 tcb  pctb    6      2   -0.21168713
48  8.5  -173.5_-4.5 -173.5  -4.5 tcb  pctb    5      2   -0.28457247
49  2.6  -173.5_-5.5 -173.5  -5.5 tcb  pctb    6      2   -0.21070219
50  8.5  -173.5_-5.5 -173.5  -5.5 tcb  pctb    5      2   -0.21852596
51  2.6  -173.5_-6.5 -173.5  -6.5 tcb  pctb    6      2   -0.20575186
52  8.5  -173.5_-6.5 -173.5  -6.5 tcb  pctb    6      2   -0.31700483
53  2.6  -173.5_-7.5 -173.5  -7.5 tcb  pctb    6      2   -0.20825984
54  8.5  -173.5_-7.5 -173.5  -7.5 tcb  pctb    6      2   -0.29140852
55  2.6  -173.5_-8.5 -173.5  -8.5 tcb  pctb    6      2   -0.16194479
56  8.5  -173.5_-8.5 -173.5  -8.5 tcb  pctb    6      2   -0.29436745
57  2.6  -173.5_-9.5 -173.5  -9.5 tcb  pctb    6      2   -0.08569174
58  8.5  -173.5_-9.5 -173.5  -9.5 tcb  pctb    6      2   -0.42096101
59  2.6   -173.5_0.5 -173.5   0.5 tcb  pctb    6      2   -0.16652844
60  8.5   -173.5_0.5 -173.5   0.5 tcb  pctb    6      2   -0.44052646
61  2.6   -173.5_1.5 -173.5   1.5 tcb  pctb    6      2   -0.16493044
62  8.5   -173.5_1.5 -173.5   1.5 tcb  pctb    6      2   -0.47594408
63  2.6  -173.5_10.5 -173.5  10.5 tcb  pctb    6      2   -0.11470804
64  8.5  -173.5_10.5 -173.5  10.5 tcb  pctb    6      2   -0.39927631
65  2.6  -173.5_11.5 -173.5  11.5 tcb  pctb    6      2   -0.09886046
66  8.5  -173.5_11.5 -173.5  11.5 tcb  pctb    6      2   -0.43369976
67  2.6  -173.5_12.5 -173.5  12.5 tcb  pctb    6      2   -0.09466836
68  8.5  -173.5_12.5 -173.5  12.5 tcb  pctb    6      2   -0.44955149
69  2.6  -173.5_13.5 -173.5  13.5 tcb  pctb    6      2   -0.09206811
70  8.5  -173.5_13.5 -173.5  13.5 tcb  pctb    6      2   -0.42470307
71  2.6  -173.5_14.5 -173.5  14.5 tcb  pctb    6      2   -0.08471772
72  8.5  -173.5_14.5 -173.5  14.5 tcb  pctb    6      2   -0.50800543
73  2.6  -173.5_15.5 -173.5  15.5 tcb  pctb    6      2   -0.08203688
74  8.5  -173.5_15.5 -173.5  15.5 tcb  pctb    6      2   -0.44977284
75  2.6  -173.5_16.5 -173.5  16.5 tcb  pctb    6      2   -0.08079325
76  8.5  -173.5_16.5 -173.5  16.5 tcb  pctb    6      2   -0.47601088
77  2.6  -173.5_17.5 -173.5  17.5 tcb  pctb    6      2   -0.08487395
78  8.5  -173.5_17.5 -173.5  17.5 tcb  pctb    6      2   -0.51251951
79  2.6  -173.5_18.5 -173.5  18.5 tcb  pctb    6      2   -0.09662917
80  8.5  -173.5_18.5 -173.5  18.5 tcb  pctb    6      2   -0.50270243
81  2.6  -173.5_19.5 -173.5  19.5 tcb  pctb    6      2   -0.10955999
82  8.5  -173.5_19.5 -173.5  19.5 tcb  pctb    6      2   -0.45340014
83  2.6   -173.5_2.5 -173.5   2.5 tcb  pctb    6      2   -0.15985633
84  8.5   -173.5_2.5 -173.5   2.5 tcb  pctb    6      2   -0.55218845
85  2.6  -173.5_20.5 -173.5  20.5 tcb  pctb    6      2   -0.12954332
86  8.5  -173.5_20.5 -173.5  20.5 tcb  pctb    6      2   -0.41732915
87  2.6  -173.5_21.5 -173.5  21.5 tcb  pctb    6      2   -0.12885921
88  8.5  -173.5_21.5 -173.5  21.5 tcb  pctb    6      2   -0.38223756
89  2.6   -173.5_3.5 -173.5   3.5 tcb  pctb    6      2   -0.14252784
90  8.5   -173.5_3.5 -173.5   3.5 tcb  pctb    6      2   -0.50508468
91  2.6   -173.5_4.5 -173.5   4.5 tcb  pctb    6      2   -0.11896409
92  8.5   -173.5_4.5 -173.5   4.5 tcb  pctb    6      2   -0.39149647
93  2.6   -173.5_5.5 -173.5   5.5 tcb  pctb    6      2   -0.13908627
94  8.5   -173.5_5.5 -173.5   5.5 tcb  pctb    6      2   -0.34529567
95  2.6   -173.5_6.5 -173.5   6.5 tcb  pctb    6      2   -0.15077232
96  8.5   -173.5_6.5 -173.5   6.5 tcb  pctb    6      2   -0.30434138
97  2.6   -173.5_7.5 -173.5   7.5 tcb  pctb    6      2   -0.13317443
98  8.5   -173.5_7.5 -173.5   7.5 tcb  pctb    6      2   -0.33599595
99  2.6   -173.5_8.5 -173.5   8.5 tcb  pctb    6      2   -0.12507628
100 8.5   -173.5_8.5 -173.5   8.5 tcb  pctb    6      2   -0.31589576
101 2.6   -173.5_9.5 -173.5   9.5 tcb  pctb    6      2   -0.11898079
102 8.5   -173.5_9.5 -173.5   9.5 tcb  pctb    6      2   -0.34859021
              bse           bpv nrcp  n
1      0.03600799  5.061262e-07    1 10
2      0.10054212  4.698827e-07    1  9
3      0.05382659  2.524559e-04    1 10
4      0.12276920  6.543605e-07    1  9
5      0.04669312  3.063238e-01    1 10
6      0.09856417  3.375515e-03    1  8
7   -999.00000000 -9.990000e+02    1 10
8      0.08446925  2.818023e-03    1  8
9   -999.00000000 -9.990000e+02    1 10
10     0.10538575  5.503667e-03    1  9
11     0.02983145  8.072494e-02    1 10
12     0.09262649  4.254085e-03    1  9
13     0.02969914  8.589412e-02    1 10
14     0.08318611  4.515357e-03    1  9
15     0.03300207  2.108412e-01    1 10
16     0.13100928  3.465846e-02    1  9
17     0.03599758  1.259871e-01    1 10
18     0.04491663  5.767836e-07    1  9
19     0.04011783  1.200020e-01    1 10
20     0.07017016  2.636177e-02    1  9
21     0.04075743  1.414785e-01    1 10
22     0.06718795  3.919105e-02    1  9
23     0.03837535  2.809836e-01    1 10
24     0.08263171  1.283160e-01    1  9
25     0.05461509  2.050848e-04    1 10
26     0.13859863  3.478892e-06    1  9
27     0.03791448  2.210106e-01    1 10
28     0.07875104  2.916028e-02    1  9
29     0.03628674  3.060225e-01    1 10
30     0.07887260  1.227296e-02    1  9
31     0.02855844  4.697537e-01    1 10
32     0.07166364  2.615932e-03    1  9
33     0.02275019  4.583716e-01    1 10
34     0.06316098  5.752877e-04    1  9
35     0.04333027  1.819401e-02    1 10
36     0.05798840  6.429405e-05    1  9
37     0.07134992  7.111250e-03    1 10
38     0.06311417  2.015660e-06    1  9
39     0.08549641  5.862392e-03    1 10
40     0.05111216  9.528195e-17    1  9
41     0.08271039  6.427169e-03    1 10
42     0.07388820  6.545661e-13    1  9
43     0.06730625  1.048598e-02    1 10
44     0.06320358  1.521869e-17    1  9
45     0.05851077  3.257410e-04    1 10
46     0.16098343  8.231268e-04    1  8
47     0.08063932  8.807064e-03    1 10
48     0.05405725  1.911213e-07    1  7
49     0.10710258  4.946176e-02    1 10
50     0.05124820  2.303307e-05    1  7
51     0.05660611  2.935658e-04    1 10
52     0.06390295  8.701494e-07    1  8
53     0.06238062  8.756917e-04    1 10
54     0.06278394  4.085984e-06    1  8
55     0.11097244  1.448128e-01    1 10
56     0.12603423  1.977508e-02    1  8
57     0.06815863  2.089814e-01    1 10
58     0.14969301  5.042515e-03    1  9
59     0.03290843  5.039599e-07    1 10
60     0.09023353  1.272975e-06    1  9
61     0.03121802  1.580776e-07    1 10
62     0.08752043  7.204764e-08    1  9
63     0.02936723  1.006091e-04    1 10
64     0.02897470  1.498244e-38    1  8
65     0.02415154  4.620276e-05    1 10
66     0.03328391  2.690756e-35    1  9
67     0.02328971  5.212106e-05    1 10
68     0.07703014  7.756000e-09    1  9
69     0.01632143  2.241966e-08    1 10
70     0.06145803  9.767928e-12    1  9
71     0.01722124  1.025886e-06    1 10
72     0.10902705  3.685428e-06    1  9
73     0.02002524  4.555438e-05    1 10
74     0.03153320  2.140712e-41    1  9
75     0.02346567  6.007843e-04    1 10
76     0.06761968  4.071816e-12    1  9
77     0.02662597  1.482138e-03    1 10
78     0.03651003  2.561849e-40    1  9
79     0.02662046  2.989632e-04    1 10
80     0.03342086  1.866689e-45    1  9
81     0.02480018  1.114424e-05    1 10
82     0.06960824  1.262500e-10    1  9
83     0.03226334  8.597809e-07    1 10
84     0.09956207  4.005764e-08    1  9
85     0.02181901  4.086707e-09    1 10
86     0.06285302  5.635750e-11    1  9
87     0.01738654  2.798574e-13    1 10
88     0.05484886  6.456451e-12    1  9
89     0.04205585  7.308187e-04    1 10
90     0.08862852  1.719549e-08    1  9
91     0.04082281  3.651695e-03    1 10
92     0.08890336  1.229087e-05    1  8
93     0.07960961  8.095187e-02    1 10
94     0.11953530  3.987480e-03    1  8
95     0.09845298  1.260153e-01    1 10
96     0.10295849  3.220997e-03    1  8
97     0.03258395  4.755228e-05    1 10
98     0.11425819  3.381338e-03    1  8
99     0.02859827  1.360584e-05    1 10
100    0.03499707  1.607624e-18    1  8
101    0.04333800  6.159622e-03    1 10
102    0.02839641  1.341672e-31    1  8


